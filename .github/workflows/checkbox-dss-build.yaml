name: checkbox-dss Snap build
permissions:
  contents: read
on:
  push:
    branches: [ main ]
    paths:
      - contrib/checkbox-dss-validation/checkbox-provider-dss/**
      - .github/workflows/checkbox-dss-build.yaml
  pull_request:
    branches: [ main ]
    paths:
      - contrib/checkbox-dss-validation/checkbox-provider-dss/**
      - .github/workflows/checkbox-dss-build.yaml
  workflow_dispatch:
  workflow_call:

jobs:
  snap_frontend_native:
    strategy:
      fail-fast: false
      matrix:
        type: [classic]
        release: [22]
        arch: [amd64]
        include:
          - arch: amd64
            tag: X64
          - release: 22
            snapcraft_version: 8.x
    runs-on:
      group: "Canonical self-hosted runners"
      labels: ["self-hosted", "linux", "jammy", "large", "${{ matrix.tag }}"]
    timeout-minutes: 1200 #20h, this will timeout sooner due to inner timeouts
    name: Frontend ${{ matrix.type }}${{ matrix.release }} (${{matrix.arch}})
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - id: snap_build
        uses: Wandalen/wretry.action@71a909ebf09f3ffdc6f42a17bd54ecb43481da49
        name: Building the snaps
        timeout-minutes: 600 # 10hours
        with:
          action: snapcore/action-build@v1.3.0
          attempt_delay: 600000 # 10min
          attempt_limit: 5
          with: |
            path: contrib/checkbox-dss-validation/
            snapcraft-channel: ${{ matrix.snapcraft_version }}/stable

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        name: Upload logs on failure
        if: failure()
        with:
          name: snapcraft-log-series-${{ matrix.type }}${{ matrix.release }}${{ matrix.arch }}
          path: |
            /home/runner/.cache/snapcraft/log/
            /home/runner/.local/state/snapcraft/log/
            contrib/checkbox-dss-validation/checkbox*.txt

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        name: Upload the snaps as artifact
        with:
          name: series_${{ matrix.type }}${{ matrix.release }}${{ matrix.arch }}
          path: ${{ steps.snap_build.outputs.snap }}

      # NOTE:@motjuste: We currently don't publish the checkbox-dss Snap
      #
      # - name: Publish track
      #   # this is done this way because the store doesn't allow the same artifact to be uploaded twice
      #   if: inputs.store_upload && (matrix.release != 24 || matrix.type != 'classic')
      #   uses: canonical/action-publish@214b86e5ca036ead1668c79afb81e550e6c54d40
      #   env:
      #     SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT7_CREDS }}
      #   with:
      #     snap: ${{ steps.snap_build.outputs.snap }}
      #     # channel is ucXX for uc snaps and XX.04 for classic snaps
      #     release: ${{ matrix.type == 'uc' && format('uc{0}', matrix.release) || format('{0}.04', matrix.release) }}/edge
      #
      # - name: Publish track + latest
      #   if: inputs.store_upload && matrix.release == 24 && matrix.type == 'classic'
      #   uses: canonical/action-publish@214b86e5ca036ead1668c79afb81e550e6c54d40
      #   env:
      #     SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT7_CREDS }}
      #   with:
      #     snap: ${{ steps.snap_build.outputs.snap }}
      #     # classic 24.04 is published to latest/edge as well
      #     release: 24.04/edge,latest/edge
