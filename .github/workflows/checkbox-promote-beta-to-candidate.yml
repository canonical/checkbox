name: Promote Checkbox beta to candidate
on:
    push:
        branches: [CHECKBOX-1447-promotion-beta-to-candidate]
    workflow_dispatch:

jobs:
  checkbox-promotion-beta-to-candidate-test:
    runs-on: [self-hosted, testflinger]
    strategy:
      fail-fast: false
      matrix:
        include:
          - queue: hp-elitebook-850-g7-notebook-pc
            data_source: "distro: jammy"
            checkbox_runtime: checkbox22
            checkbox_track: uc22
          - queue: hp-elitebook-850-g7-notebook-pc
            data_source: "distro: jammy"
    steps:
    - name: Checkout checkbox monorepo
      uses: actions/checkout@v4

    - name: Create job file (by instantiating template)
      id: create-job
      run: |
        JOB_PATH=${{ github.workspace }}/job.yaml
        # instantiate job template with input values
        INPUT_QUEUE="${{ matrix.queue }}" \
        INPUT_DATA_SOURCE="${{ matrix.data_source }}" \
        INPUT_CHECKBOX_RUNTIME="${{ matrix.checkbox_runtime }}" \
        INPUT_CHECKBOX_TRACK="${{ matrix.checkbox_track }}" \
        INPUT_RESOURCES_PATH="${{ github.workspace }}/.github/workflows/checkbox-promote-beta-to-candidate/resources" \
        envsubst '$INPUT_QUEUE $INPUT_DATA_SOURCE $INPUT_CHECKBOX_RUNTIME $INPUT_CHECKBOX_TRACK $INPUT_RESOURCES_PATH' \
        < $GITHUB_WORKSPACE/.github/workflows/checkbox-promote-beta-to-candidate/job.template \
        > $JOB_PATH
        # return path for instantiated job file
        echo "job=$JOB_PATH" >> $GITHUB_OUTPUT

    - name: Submit job
      uses: canonical/testflinger/.github/actions/submit@main
      with:
        poll: true
        job-path: ${{ steps.create-job.outputs.job }}