name: checkbox snap daily build

on:
  schedule:
    - cron: '00 04 * * *'
  workflow_dispatch:
  workflow_call:

jobs:
  check_history:
    runs-on: ubuntu-latest
    name: Check for new commits
    outputs:
      should_run: ${{ steps.check_log.outputs.should_run }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Check for checkbox snap new commits
        id: check_log
        run: |
          git rev-list --abbrev-commit --pretty=oneline HEAD --not $(git rev-list -n1 --before="24 hours" --first-parent HEAD) -- checkbox-ng checkbox-support providers checkbox-core-snap checkbox-snap
          changes=$(git rev-list --abbrev-commit --pretty=oneline HEAD --not $(git rev-list -n1 --before="24 hours" --first-parent HEAD) -- checkbox-ng checkbox-support providers checkbox-core-snap checkbox-snap)
          if [[ -z $changes ]]
            then
              echo "should_run=false" >> $GITHUB_OUTPUT
            else
              echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  snap:
    strategy:
      matrix:
        type: [classic, uc]
        releases: [16, 18, 20, 22]
    needs: check_history
    if: ${{ needs.check_history.outputs.should_run != 'false' }} || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      SERIES: series_${{ matrix.type }}${{ matrix.releases }}
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT7_CREDS }}
    name: Checkbox snap for series ${{ matrix.type }}${{ matrix.releases }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Copy over the common files for series ${{ matrix.type }}${{ matrix.releases }}
        run: |
          cd checkbox-snap/
          sudo apt update && sudo apt install -qq -y python3-setuptools-scm
          ./prepare_${{ matrix.type }}.sh $SERIES
      - name: add LP credentials
        run: |
          mkdir -p ~/.local/share/snapcraft/provider/launchpad/
          echo '${{ secrets.LP_CREDS }}' > ~/.local/share/snapcraft/provider/launchpad/credentials
          git config --global user.email "robot@lists.canonical.com"
          git config --global user.name "Certification bot"
      - uses: Wandalen/wretry.action@a163f62ae554a8f3cbe27b23db15b60c0ae2e93c # 1.3.0
        with:
          action: snapcore/action-build@v1
          id: snapcraft
          attempt_delay: 600000 # 10min
          attempt_limit: 3
          with: |
            path: checkbox-snap/series_${{ matrix.type }}${{ matrix.releases }}
            snapcraft-channel: 7.x/stable
            snapcraft-args: remote-build --build-on amd64,arm64,armhf,i386 --launchpad-accept-public-upload
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: snapcraft-log-series-${{ matrix.type }}${{ matrix.releases }}
          path: |
            /home/runner/.cache/snapcraft/log/
            /home/runner/.local/state/snapcraft/log/
            checkbox-snap/series_${{ matrix.type }}${{ matrix.releases }}/checkbox*.txt
      - uses: actions/upload-artifact@v3
        with:
          name: series_${{ matrix.type }}${{ matrix.releases }}
          path: checkbox-snap/series_${{ matrix.type }}${{ matrix.releases }}/*.snap
      - uses: nick-fields/retry@14672906e672a08bd6eeb15720e9ed3ce869cdd4 # v2.9.0
        with:
          name: Upload checkbox snaps to the store
          retry_wait_seconds: 600 # 10min
          max_attempts: 3
          run: |
            for snap in checkbox-snap/series_${{ matrix.type }}${{ matrix.releases }}/*.snap
            do
              echo "Uploading $snap..."
              if [[ ${{ matrix.type }} == 'classic' ]]; then
                if [[ ${{ matrix.releases }} == '22' ]]; then
                  snapcraft upload $snap --release ${{ matrix.releases }}.04/edge,latest/edge
                else
                  snapcraft upload $snap --release ${{ matrix.releases }}.04/edge
                fi
              else
                snapcraft upload $snap --release ${{ matrix.type }}${{ matrix.releases }}/edge
              fi
            done
