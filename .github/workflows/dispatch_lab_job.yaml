name: Run Workflow on PR Comment
on:
  workflow_dispatch:
    inputs:
      matrix_to_create:
        description: 'Json formatted description of the jobs to dispatch'
        required: true
        type: string

jobs:
  run-matrix:
    runs-on: [self-hosted, testflinger]
    strategy:
      matrix:
        spec: ${{ fromJson(inputs.matrix_to_create) }}
    defaults:
      run:
        working-directory: tools/lab_dispatch
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: |
          sudo apt install gettext
          sudo snap install testflinger-cli
      - name: Dispatch test in the lab and monitor it
        env:
          INPUT_DATA_SOURCE: ${{ matrix.spec.data_source }}
          INPUT_QUEUE: ${{ matrix.spec.queue }}
          INPUT_MATCH: ${{ matrix.spec.match }}
          INPUT_TEST_PLAN: ${{ matrix.spec.test_plan }}
          INPUT_PASSWORD_SECRET: ${{ secrets.INPUT_PASSWORD_SECRET }}
        run: |
          echo "::group::Building the job.yaml"
          export INPUT_CHECKBOX_REVISION="$(git rev-parse HEAD)"
          envsubst '$INPUT_CHECKBOX_REVISION $INPUT_DATA_SOURCE $INPUT_QUEUE' < generic_source.yaml | tee job.yaml
          echo "::endgroup::"

          echo "::group::Building the input.conf"
          envsubst '$INPUT_TEST_PLAN $INPUT_MATCH $INPUT_PASSWORD_SECRET' < resources/input.conf_template | tee resources/input.conf
          echo "::endgroup::"

          testflinger submit -p job.yaml
