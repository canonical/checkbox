name: Data Science Stack (DSS) Regression Testing
permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      dss_channel:
        description: "Channel of the DSS snap to test"
        default: latest/edge
        required: false
        type: choice
        options:
          - latest/edge
          - latest/stable
          - 1.1/edge
          - 1.1/stable
          - 1.0/edge
          - 1.0/stable
      k8s_type:
        description: "The type of K8s to deploy"
        default: "canonical-k8s"
        required: false
        type: choice
        options:
          - canonical-k8s
          - microk8s
      k8s_channel:
        description: "Channel of the K8s snap to deploy"
        default: "1.32-classic/stable"
        type: string

env:
  BRANCH: ${{ github.head_ref || github.ref_name }}

jobs:
  dss-snap-frontend-native-build:
    uses: ./.github/workflows/checkbox-dss-build.yaml

  regression-tests:
    needs: dss-snap-frontend-native-build
    name: Regression tests
    runs-on: [testflinger]
    defaults:
      run:
        working-directory: contrib/checkbox-dss-validation
    strategy:
      fail-fast: false
      matrix:
        queue:
          - name: dell-precision-3470-c30322 #ADL iGPU + NVIDIA GPU
            provision_data: "distro: jammy"
          - name: dell-precision-5680-c31665 #RPL iGPU + Arc Pro A60M dGPU
            provision_data: "url: http://10.102.196.9/somerville/Platforms/jellyfish-muk/X96_A00/dell-bto-jammy-jellyfish-muk-X96-20230419-19_A00.iso"
          - name: nvidia-dgx-station-c25989  # NO iGPU + NVIDIA GPU
            provision_data: "distro: jammy"
    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        name: Download the artifact with the built snap
        with:
          name: checkbox-dss.snap
          path: checkbox-dss.snap
      - name: Build job file from template
        env:
          DSS_CHANNEL: ${{ inputs.dss_channel }}
          K8S_TYPE: ${{ inputs.k8s_type }}
          K8S_CHANNEL: ${{ inputs.k8s_channel }}
        run: |
          sed -e "s|REPLACE_QUEUE|${{ matrix.queue.name }}|" \
          -e "s|REPLACE_PROVISION_DATA|${{ matrix.queue.provision_data }}|" \
          -e "s|REPLACE_DSS_CHANNEL|${DSS_CHANNEL}|" \
          -e "s|REPLACE_K8S_TYPE|${K8S_TYPE}|" \
          -e "s|REPLACE_K8S_CHANNEL|${K8S_CHANNEL}|" \
          ${GITHUB_WORKSPACE}/contrib/checkbox-dss-validation/testflinger/job-def.yaml > \
          ${GITHUB_WORKSPACE}/job.yaml
          cat ${GITHUB_WORKSPACE}/job.yaml
          echo ${GITHUB_WORKSPACE}
          ls -lah ${GITHUB_WORKSPACE}
      # - name: Submit testflinger job
        # uses: canonical/testflinger/.github/actions/submit@a5c430ce76f981b5f344c65d82201a27f1e8c18a
        # with:
          # poll: true
          # job-path: ${GITHUB_WORKSPACE}/job.yaml
