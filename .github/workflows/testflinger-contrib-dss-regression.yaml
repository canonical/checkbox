name: Data Science Stack (DSS) Regression Testing
permissions:
  contents: read
on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 7 * * 1" # every Monday 07:00 UTC
  # push:
  #   branches:
  #     - main
  # pull_request:
  #   branches:
  #     - main

env:
  BRANCH: ${{ github.head_ref || github.ref_name }}

jobs:
  checkbox-dss-snap-build:
    uses: ./.github/workflows/checkbox-dss-build.yaml

  regression-tests:
    needs: checkbox-dss-snap-build
    name: Regression tests
    runs-on: [testflinger]
    defaults:
      run:
        working-directory: contrib/checkbox-dss-validation
    strategy:
      fail-fast: false
      matrix:
        dss_channel:
          - 1/stable
          # - 1/candidate
          # - latest/edge
        microk8s_channel:
          - 1.28/stable
          # - 1.31/stable
        queue:
          - name: dell-precision-3470-c30322 #ADL iGPU + NVIDIA GPU
            provision_data: "distro: jammy"
          # - name: dell-precision-5680-c31665 #RPL iGPU + Arc Pro A60M dGPU
          #   provision_data: "url: http://10.102.196.9/somerville/Platforms/jellyfish-muk/X96_A00/dell-bto-jammy-jellyfish-muk-X96-20230419-19_A00.iso"
          # - name: nvidia-dgx-station-c25989  # NO iGPU + NVIDIA GPU
          #   provision_data: "distro: jammy"
    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        name: Download artifact with the built snap
        with:
          name: checkbox-dss.snap
      - name: Find path to the built snap
        id: built-snap
        run: |
          echo "::group::State of current directory"
          pwd
          ls -lah
          echo "::endgroup::"
          echo "local_path=$(find checkbox-dss*.snap | head -1)" >> $GITHUB_OUTPUT
      - name: Build job file from template
        env:
          WITH_QUEUE: "${{ matrix.queue.name }}"
          WITH_PROVISION_DATA: "${{ matrix.queue.provision_data }}"
          WITH_DSS_CHANNEL: "${{ matrix.dss_channel }}"
          WITH_MICROK8S_CHANNEL: "${{ matrix.microk8s_channel }}"
        run: |
          sed -e "s|REPLACE_BRANCH|${BRANCH}|" \
          -e "s|REPLACE_QUEUE|${WITH_QUEUE}|" \
          -e "s|REPLACE_PROVISION_DATA|${WITH_PROVISION_DATA}|" \
          -e "s|REPLACE_DSS_CHANNEL|${WITH_DSS_CHANNEL}|" \
          -e "s|REPLACE_MICROK8S_CHANNEL|${WITH_MICROK8S_CHANNEL}|" \
          testflinger/job-def.yaml > job.yaml
          echo "::group::Built job file"
          cat job.yaml
          echo "::endgroup::"
      - name: Submit testflinger job
        uses: canonical/testflinger/.github/actions/submit@a5c430ce76f981b5f344c65d82201a27f1e8c18a
        with:
          poll: true
          job-path: job.yaml
