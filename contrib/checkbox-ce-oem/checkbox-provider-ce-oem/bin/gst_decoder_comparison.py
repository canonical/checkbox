#!/usr/bin/env python3
# This file is part of Checkbox.
#
# Copyright 2024 Canonical Ltd.
# Written by:
#   Rick Wu <rick.wu@canonical.com>
#
# Checkbox is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3,
# as published by the Free Software Foundation.
#
# Checkbox is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Checkbox. If not, see <http://www.gnu.org/licenses/>.

import argparse
import logging
import os
import shlex
import subprocess
from typing import Any

logging.basicConfig(level=logging.INFO)


def register_arguments():
    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description=(
            "Script helps verify the MD5 checksum from specific Gstreamer"
            " Decoder with different resolutions and color spaces is exactly"
            " match golden reference"
        ),
    )

    parser.add_argument(
        "-p",
        "--pipeline",
        required=True,
        type=str,
        help="Gstreamer pipeline for comparison",
    )

    parser.add_argument(
        "-gp",
        "--golden_pipeline",
        required=True,
        type=str,
        help="Golden Gstreamer pipeline for comparison",
    )
    args = parser.parse_args()
    return args


def get_md5_checksum_from_command(cmd: str) -> str:
    """
    Executes the GStreamer command and extracts the MD5 checksums.

    :param cmd:
        The GStreamer command to execute.

    :returns:
        The extracted MD5 checksums.
    """
    try:
        logging.info("Starting command: '{}'".format(cmd))
        ret = subprocess.run(
            shlex.split(cmd),
            check=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            encoding="utf-8",
            timeout=30,
        )
        md5_data = "".join(ret.stdout.splitlines(True)[-1].split(":")[-1])
        return md5_data.strip()
    except Exception as e:
        logging.error(e.stderr)
        raise SystemExit(e.returncode)


def validate_video_decoder_md5_checksum(args: Any) -> None:
    """
    Validates the MD5 checksum of the output generated by a video decoder with
    specific resolution and color space.

    This function performs the following steps:

    1. Checks if the golden sample file and the golden MD5 checksum file exist.
    2. Builds a GStreamer command to process the golden sample using the
        specified decoder and color space.
    3. Executes the GStreamer command and extracts the MD5 checksums from the
        output.
    4. Reads the golden MD5 checksum from the file.
    5. Compares the extracted MD5 checksum with the golden MD5 checksum.
    6. If the checksums match, logs a "Pass" message. If they don't match,
        logs the golden MD5 checksum and raises a `SystemExit` exception.

    :param args:
        An object containing the following attributes:
            - `golden_sample_path` (str): The path to the golden sample file.
            - `golden_sample_md5_checksum_path` (str): The path to the file
                containing the golden MD5 checksum.
            - `decoder_plugin` (str): The video decoder to use, e.g.,
                "v4l2vp8dec", "v4l2vp9dec".
            - `color_space` (str): The desired color space format for the
                output, e.g., "I420", "NV12".

    :raises SystemExit:
        If the golden sample file or the golden MD5 checksum file does not
        exist, or if the extracted MD5 checksum does not match the golden MD5
        checksum.
    """
    # Run command to get comapred md5 checksum by consuming golden sample
    gst_launch_bin = os.getenv("GST_LAUNCH_BIN", "gst-launch-1.0")
    pipeline = args.pipeline
    golden_pipeline = args.golden_pipeline
    cmd = "{} -v {}".format(gst_launch_bin, pipeline)
    golden_cmd = "{} -v {}".format(gst_launch_bin, golden_pipeline)
    compared_md5_data = get_md5_checksum_from_command(cmd)
    golden_md5_data = get_md5_checksum_from_command(golden_cmd)

    logging.info(
        "===== MD5 Checksum: {} ====\n{}\\n".format(
            pipeline,
            compared_md5_data,
        )
    )
    logging.info(
        "===== Golden MD5 Checksum: {} ====\n{}\\n".format(
            golden_pipeline,
            golden_md5_data,
        )
    )

    if golden_md5_data == compared_md5_data:
        logging.info("Pass. MD5 checksum is same as Golden Sample")
    else:
        raise SystemExit("Failed. MD5 checksum is not same as Golden Sample")


def main() -> None:
    args = register_arguments()
    validate_video_decoder_md5_checksum(args)


if __name__ == "__main__":
    main()
